version: "3.7"

services:

  xnat-traefik:
    container_name: xnat-traefik
    image: "traefik:latest"
    networks:
      - xnat-services
    command:
      - --entrypoints.web.address=:80
      - --providers.docker=true
    ports:
      - "80:80"
      - "8080:8080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./traefik/config/traefik.yml:/etc/traefik/traefik.yml
      - ./traefik-data/logs:/var/log
    labels:
      - "traefik.enable=true"
      - "traefik.http.middlewares.strip-routes.stripprefix.prefixes=/pacs"
      - "traefik.http.middlewares.service-redirect.redirectregex.regex=^(https|http)://([a-zA-Z0-9_.-]+)/([a-zA-Z0-9_.-]+)$$"
      - "traefik.http.middlewares.service-redirect.redirectregex.replacement=$${1}://$${2}/$${3}/"
      - "traefik.http.middlewares.append-slash-to-training.redirectregex.regex=^(.+/training/[^/]+)$$"
      - "traefik.http.middlewares.append-slash-to-training.redirectregex.replacement=$${1}/"
      - "traefik.http.routers.traefik_dash.rule=PathPrefix(`/dashboard`)"
      - "traefik.http.routers.traefik_dash.middlewares=service-redirect@docker,strip-routes@docker"
      - "traefik.http.services.traefik_dash.loadbalancer.server.port=8080"

  xnat-web:
    container_name: xnat-web
    image: xnat-web
    networks: [xnat-services]
    build:
      context: ./xnat
      args:
        XNAT_VERSION: "${XNAT_VERSION}"
        XNAT_SMTP_ENABLED: "${XNAT_SMTP_ENABLED}"
        XNAT_SMTP_HOSTNAME: "${XNAT_SMTP_HOSTNAME}"
        XNAT_SMTP_PORT: "${XNAT_SMTP_PORT}"
        XNAT_SMTP_AUTH: "${XNAT_SMTP_AUTH}"
        XNAT_SMTP_USERNAME: "${XNAT_SMTP_USERNAME}"
        XNAT_SMTP_PASSWORD: "${XNAT_SMTP_PASSWORD}"
        XNAT_DATASOURCE_DRIVER: "${XNAT_DATASOURCE_DRIVER}"
        XNAT_DATASOURCE_URL: "${XNAT_DATASOURCE_URL}"
        XNAT_DATASOURCE_USERNAME: "${XNAT_DATASOURCE_USERNAME}"
        XNAT_DATASOURCE_PASSWORD: "${XNAT_DATASOURCE_PASSWORD}"
        XNAT_ACTIVEMQ_URL: "${XNAT_ACTIVEMQ_URL}"
        XNAT_ACTIVEMQ_USERNAME: "${XNAT_ACTIVEMQ_USERNAME}"
        XNAT_ACTIVEMQ_PASSWORD: "${XNAT_ACTIVEMQ_PASSWORD}"
        XNAT_WEBAPP_FOLDER: "${XNAT_WEBAPP_FOLDER}"
        XNAT_ROOT: "${XNAT_ROOT}"
        XNAT_HOME: "${XNAT_HOME}"
        XNAT_EMAIL: "${XNAT_EMAIL}"
    expose:
      - 8080
    ports:
      - "8104:8104"
      - "8144:8144"
    labels:
      - "traefik.http.routers.xnat-web.rule=PathPrefix(`/`)"
      - "traefik.http.services.xnat-web.loadbalancer.server.port=8080"
    volumes:
      - ./xnat-data/archive:/data/xnat/archive
      - ./xnat-data/build:/data/xnat/build
      - ./xnat-data/config:/data/xnat/home/config
      - ./xnat-data/logs:/data/xnat/home/logs
      - ./xnat-data/plugins:/data/xnat/home/plugins
      - ./xnat-data/webapps:/usr/local/tomcat/webapps
      - ./xnat-data/tomcat:/usr/local/tomcat/logs
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      CATALINA_OPTS: "-Xms${XNAT_MIN_HEAP} -Xmx${XNAT_MAX_HEAP} -Dxnat.home=${XNAT_HOME}"
      PGPASSWORD: "${XNAT_DATASOURCE_PASSWORD}"
      XNAT_HOME: "${XNAT_HOME}"

  xnat-db:
    container_name: xnat-db
    image: xnat-db
    networks: [xnat-services]
    build:
      context: ./postgres
    environment:
      POSTGRES_PASSWORD: ${XNAT_DATASOURCE_ADMIN_PASSWORD}
    expose:
      - 5432
    volumes:
      - ./postgres-data:/var/lib/postgresql/data

networks:
  xnat-services:
    name: xnat-services
    driver: bridge
